<html lang="fr">
    <head>
        <meta property="og:image" content="https://www.lisv.uvsq.fr/uas/lisv/LOGO/logo-lisv-2020.jpg" />
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <title>LISV Contrats</title>
        <link rel="icon" type="image/png" href="https://www.lisv.uvsq.fr/jsp/images/favicon.png" />
        <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" type="text/css" media="screen" href="https://www.lisv.uvsq.fr/wro/styles/634ade602296c910871b52c6c993802fd75d133e.css"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <style media="screen, print">
            #pied_page_complement, #pied_page_complement a {
                color: white;
                background: #7f7f7f;
                position: fixed;
                bottom:0;
                width: 100%;
            }

            #menu {
                background: #4f8f00;
            }

            a, a:active, a:focus, a:visited {
                color: #005493;
            }

            h1, h2, h3 {
                color: #005493;
            }

            ::selection {
                background-color: #005493;
                color: white;
            }

            ::-moz-selection {
                background-color: #005493;
                color: white;
            }

            button {
                background-color: white;
                color: #005493;
                border: 1px solid #005493;
                border-radius: 4px;
                padding: 8px 12px;
                cursor: pointer;
                font-family: 'Montserrat', sans-serif;
                font-size: 14px;
            }

            button:hover {
                background-color: #005493;
                color: white;
                border: 1px solid #005493;
            }

            button:focus, button:active {
                outline: 1px dotted #005493;
            }

            .content-container {
                margin: 20px;
                margin-bottom: 200px;
            }

            /* Styles pour les filtres */
            .filters-section {
                background-color: #f8f9fa;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 30px;
                border: 1px solid #dee2e6;
            }

            .filters-form {
                display: flex;
                flex-wrap: wrap;
                gap: 15px;
                align-items: end;
            }

            .filter-group {
                display: flex;
                flex-direction: column;
                min-width: 180px;
            }

            .filter-group label {
                font-weight: bold;
                margin-bottom: 8px;
                color: #333;
                font-size: 15px;
            }

            .filter-group input, .filter-group select {
                padding: 8px 12px;
                border: 1px solid #ccc;
                border-radius: 4px;
                font-size: 14px;
                font-family: 'Montserrat', sans-serif;
                color: #333;
                background-color: white;
                height: 38px;
                box-sizing: border-box;
            }

            .filter-group input[list] {
                cursor: text;
                background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
                background-position: right 8px center;
                background-repeat: no-repeat;
                background-size: 16px;
                padding-right: 32px;
            }

            .filter-group input:focus, .filter-group select:focus {
                border-color: #005493;
                outline: none;
                box-shadow: 0 0 5px rgba(0, 84, 147, 0.3);
            }

            /* Styles pour les statistiques */
            .statistics-section {
                display: flex;
                gap: 20px;
                margin-bottom: 30px;
                flex-wrap: wrap;
            }

            .stat-card {
                background-color: #005493;
                color: white;
                padding: 20px;
                border-radius: 8px;
                text-align: center;
                flex: 1;
                min-width: 200px;
            }

            .stat-number {
                font-size: 2.5em;
                font-weight: bold;
                margin-bottom: 10px;
            }

            .stat-label {
                font-size: 1.1em;
                opacity: 0.9;
            }

            /* Styles pour les contrats */
            .contracts-list {
                margin-bottom: 30px;
            }

            .contract-item {
                background-color: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 20px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                transition: box-shadow 0.3s ease;
                position: relative;
            }

            .contract-item:hover {
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            }

            .contract-title {
                font-size: 1.3em;
                font-weight: bold;
                color: #005493;
                margin-bottom: 10px;
                line-height: 1.4;
            }

            .contract-subtitle {
                color: #666;
                margin-bottom: 15px;
                font-style: italic;
                font-size: 1.1em;
            }

            .contract-meta {
                display: flex;
                gap: 20px;
                margin-bottom: 15px;
                flex-wrap: wrap;
            }

            .contract-meta span {
                background-color: #f8f9fa;
                padding: 6px 12px;
                border-radius: 4px;
                font-size: 0.9em;
                color: #495057;
                display: flex;
                align-items: center;
                gap: 5px;
            }

            .contract-meta .amount {
                background-color: #28a745;
                color: white;
                font-weight: bold;
            }

            .contract-dates {
                margin-bottom: 15px;
                padding: 10px;
                background-color: #f8f9fa;
                border-radius: 4px;
                border-left: 4px solid #005493;
            }

            .contract-dates strong {
                color: #005493;
            }

            /* Styles pour les actions PDF */
            .contract-actions {
                margin-top: 15px;
                display: flex;
                gap: 10px;
                align-items: center;
            }

            .pdf-button {
                background-color: #007bff;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.9em;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                gap: 5px;
                transition: all 0.3s ease;
                min-width: 140px;
                justify-content: center;
                font-family: 'Montserrat', sans-serif;
            }

            .pdf-button:hover:not(:disabled) {
                background-color: #0056b3;
                color: white;
                text-decoration: none;
                transform: translateY(-1px);
            }

            .pdf-button:disabled {
                cursor: not-allowed;
                opacity: 0.6;
            }

            .pdf-button.available {
                background-color: #dc3545;
            }

            .pdf-button.available:hover {
                background-color: #c82333;
            }

            .pdf-button.not-available {
                background-color: #6c757d;
            }

            .pdf-button.checking {
                background-color: #ffc107;
                color: #333;
            }

            .pdf-icon {
                width: 16px;
                height: 16px;
                flex-shrink: 0;
            }

            .pdf-spinner {
                width: 16px;
                height: 16px;
                border: 2px solid transparent;
                border-top: 2px solid currentColor;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            /* Aucun r√©sultat */
            .no-results {
                text-align: center;
                padding: 40px;
                color: #666;
                font-style: italic;
            }

            #menu_principal .menu_n1_desktop {
                color: white !important;
                text-decoration: none;
                padding: 10px 15px;
                border-radius: 0;
                display: block;
                transition: all 0.3s ease;
            }

            #menu_principal li:not(.menu_principal-actif) .menu_n1_desktop {
                background-color: #4f8f00 !important;
            }

            #menu_principal li:not(.menu_principal-actif) .menu_n1_desktop:hover {
                color: #005493 !important;
                background-color: #4f8f00 !important;
            }

            #menu_principal .menu_principal-actif .menu_n1_desktop,
            #menu_principal .menu_principal-actif.UVSQNEWS > a,
            #menu_principal .menu_principal-actif.UVSQNEWS > a span {
                color: white !important;
                background-color: #005493 !important;
            }

            @media (max-width: 768px) {
                .content-container {
                    margin: 10px;
                }

                .contract-meta {
                    flex-direction: column;
                    gap: 10px;
                }

                .filters-form {
                    flex-direction: column;
                    align-items: stretch;
                }

                .filter-group {
                    min-width: auto;
                }

                .statistics-section {
                    flex-direction: column;
                }
            }
        </style>
    </head>

    <body class="not-admin">
        <div class="cartouche">
            <div>
                <div class="banniere clearfix" role="banner">
                    <div class="banniere__logos banniere__logos__1">
                        <div class="banniere__logo banniere__logo__desktop">
                            <a href="https://www.lisv.uvsq.fr/" title="Retour √† la page d'accueil">
                                <img src="https://www.lisv.uvsq.fr/uas/lisv/LOGO/logo-lisv-2020.jpg" alt="UVSQ | Universit√© Paris-Saclay | Aller √† la page d'accueil"/>
                            </a>
                        </div>
                        <div class="banniere__logo banniere__logo__mobile"></div>
                        <div class="banniere__logo banniere__logo__desktop"></div>
                        <div class="banniere__logo banniere__logo__desktop"></div>
                    </div>
                    <div class="banniere_baseline_reseaux">
                        <div class="banniere__baselines">
                            <div class="banniere__baseline">Laboratoire d' Ing√©nierie des Syst√®mes de Versailles (LISV)</div>
                            <div class="banniere__baseline__complement">Universit√© de Versailles Saint-Quentin-en-Yvelines</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <nav id="menu" role="navigation" class="plier-deplier__contenu--clos" aria-expanded="false" aria-label="Menu principal">
            <ul id="menu_principal" class="menu_principal--riche mobile-menu__level js-mobile-menu__level">
                <li class="close-button-main"></li>
                <li class="mobile-menu__item js-mobile-menu__item menu__level--0">
                    <a class="menu_n1_desktop type_rubrique_UVSQNEWS item__control-level-0" href="/" aria-expanded="false" role="button">
                        <span>Effectif</span>
                    </a>
                </li>
                <li class="menu_principal-actif UVSQNEWS mobile-menu__item js-mobile-menu__item menu__level--0 mobile-menu__item--UVSQNEWS">
                    <a class="menu_n1_desktop type_rubrique_UVSQNEWS item__control-level-0" href="/contrats" aria-expanded="false" role="button">
                        <span>Contrats</span>
                    </a>
                </li>
                <li class="mobile-menu__item js-mobile-menu__item menu__level--0">
                    <a class="menu_n1_desktop type_rubrique_UVSQNEWS item__control-level-0" href="/publications" aria-expanded="false" role="button">
                        <span>Publications HAL</span>
                    </a>
                </li>
                <li class="mobile-menu__item js-mobile-menu__item menu__level--0">
                    <a class="menu_n1_desktop type_rubrique_UVSQNEWS item__control-level-0" href="/tableau" aria-expanded="false" role="button">
                        <span>Tableau de donn√©es</span>
                    </a>
                </li>
            </ul>
        </nav>

        <main>
            <div class="content-container">
                <h1>Contrats du LISV</h1>

                {% if selected_year %}
                <div class="year-info">
                    <h3>Contrats actifs en {{ selected_year }}</h3>
                    <p><strong>{{ contrats|length }}</strong> contrat(s) trouv√©(s) pour cette ann√©e</p>
                    <p><a href="/contrats" style="background-color: #6c757d; color: white; padding: 8px 15px; text-decoration: none; border-radius: 4px;">Afficher toutes les ann√©es</a></p>
                </div>
                {% endif %}

                <!-- Boutons d'action -->
                <div class="action-buttons">
                    {% if current_user.is_authenticated %}
                    <button type="button" onclick="window.location.href='/logout'">D√©connexion</button>
                    {% endif %}
                </div>

                <br>

                <!-- Section des statistiques -->
                <div class="statistics-section">
                    <div class="stat-card">
                        <div class="stat-number" id="currentContracts">0</div>
                        <div class="stat-label">Contrats en cours</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="currentYearAmount">0 ‚Ç¨</div>
                        <div class="stat-label">Montant ann√©e en cours</div>
                    </div>
                </div>

                <!-- Section des filtres -->
                <div class="filters-section">
                    <h3>Filtres de recherche</h3>
                    <form method="GET" class="filters-form">
                        <div class="filter-group">
                            <label for="responsable">Responsable :</label>
                            <input type="text" id="responsable" name="responsable"
                                   placeholder="Nom du responsable"
                                   value="{{ request.args.get('responsable', '') }}">
                        </div>

                        <div class="filter-group">
                            <label for="year">Ann√©e :</label>
                            <input type="text" id="year" name="year" list="years-list"
                                   placeholder="Ann√©e s√©lectionn√©e"
                                   value="{{ selected_year or '' }}">
                            <datalist id="years-list">
                                <script>
                                    const currentYear = new Date().getFullYear();
                                    const yearsDatalist = document.getElementById('years-list');
                                    for (let i = 0; i < 5; i++) {
                                        const year = currentYear - i;
                                        const option = document.createElement('option');
                                        option.value = year;
                                        yearsDatalist.appendChild(option);
                                    }
                                </script>
                            </datalist>
                        </div>

                        <div class="filter-group">
                            <button type="submit">Filtrer</button>
                        </div>

                        <div class="filter-group">
                            <a href="/contrats" style="background-color: #6c757d; color: white; padding: 8px 15px; text-decoration: none; border-radius: 4px; height: 38px; display: flex; align-items: center; box-sizing: border-box;">
                                R√©initialiser
                            </a>
                        </div>
                    </form>
                </div>

                <!-- R√©sultats -->
                <div style="margin-bottom: 20px;">
                    <strong>{{ contrats|length }}</strong> contrat(s) trouv√©(s)
                    {% if selected_year or request.args.get('responsable') %}
                        avec les filtres appliqu√©s
                    {% endif %}
                </div>

                <div id="saveNotification" class="save-notification">Modifications enregistr√©es avec succ√®s!</div>

                <!-- Liste des contrats -->
                {% if contrats %}
                <div class="contracts-list">
                    {% for contrat in contrats %}
                    <div class="contract-item" data-eotp="{{ contrat[0] if contrat[0] else '' }}">

                        <!-- Titre principal -->
                        <div class="contract-title">
                            {{ contrat[1] if contrat[1] else 'Projet sans nom' }}
                        </div>

                        <!-- Sous-titre -->
                        {% if contrat[2] %}
                        <div class="contract-subtitle">
                            <strong>Convention :</strong> {{ contrat[2] }}
                        </div>
                        {% endif %}

                        <!-- M√©tadonn√©es -->
                        <div class="contract-meta">
                            {% if contrat[0] %}
                            <span>
                                <strong>EOTP :</strong> {{ contrat[0] }}
                            </span>
                            {% endif %}

                            {% if contrat[3] %}
                            <span>
                                <strong>üë§ Responsable :</strong> {{ contrat[3] }}
                            </span>
                            {% endif %}

                            {% if contrat[6] %}
                            <span>
                                <strong>üè¢ Financeur :</strong> {{ contrat[6] }}
                            </span>
                            {% endif %}

                            {% if contrat[7] %}
                            <span class="amount">
                                <strong>üí∞ Montant :</strong> {{ "{:,.2f}".format(contrat[7]) }} ‚Ç¨
                            </span>
                            {% endif %}
                        </div>

                        <!-- Dates -->
                        <div class="contract-dates">
                            <strong>üìÖ P√©riode du contrat :</strong><br>
                            Du {{ contrat[4] if contrat[4] else 'Non d√©finie' }}
                            au {{ contrat[5] if contrat[5] else 'Non d√©finie' }}
                        </div>

                        <!-- Actions du contrat (PDF) -->
                        {% if contrat[0] %}
                        <div class="contract-actions">
                            <button class="pdf-button checking" data-eotp="{{ contrat[0] }}" onclick="handlePdfClick('{{ contrat[0] }}')">
                                <div class="pdf-spinner"></div>
                                <span class="pdf-text">V√©rification...</span>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                {% else %}
                <div class="no-results">
                    {% if selected_year or request.args.get('responsable') %}
                        Aucun contrat trouv√© avec les crit√®res s√©lectionn√©s.
                    {% else %}
                        Aucun contrat trouv√© pour le moment.
                    {% endif %}
                </div>
                {% endif %}

            </div>
        </main>


        <script>
            // √âtat global des PDF
            const pdfStates = new Map();

            // Fonction pour g√©rer le clic sur un bouton PDF
            function handlePdfClick(eotp) {
                const state = pdfStates.get(eotp);

                if (state && state.exists) {
                    // PDF existe, l'ouvrir
                    window.open(`/contrats/${eotp}/pdf`, '_blank');
                } else if (!state || !state.checked) {
                    // Pas encore v√©rifi√©, v√©rifier maintenant
                    checkSinglePdf(eotp);
                }
                // Si d√©j√† v√©rifi√© et n'existe pas, ne rien faire
            }

            // V√©rification d'un seul PDF
            function checkSinglePdf(eotp) {
                const button = document.querySelector(`[data-eotp="${eotp}"]`);
                if (!button) return;

                updateButtonState(button, 'checking', 'V√©rification...', true);

                fetch(`/contrats/${eotp}/check-pdf`)
                    .then(response => response.json())
                    .then(data => {
                        pdfStates.set(eotp, {
                            checked: true,
                            exists: data.exists,
                            url: data.url
                        });

                        if (data.exists) {
                            updateButtonState(button, 'available', 'Voir le PDF', false);
                            // Ouvrir automatiquement le PDF apr√®s v√©rification
                            window.open(`/contrats/${eotp}/pdf`, '_blank');
                        } else {
                            updateButtonState(button, 'not-available', 'PDF non disponible', true);
                        }
                    })
                    .catch(error => {
                        console.error('Erreur v√©rification PDF:', error);
                        updateButtonState(button, 'not-available', 'Erreur', true);
                        pdfStates.set(eotp, { checked: true, exists: false });
                    });
            }

            // V√©rification en lot des PDF au chargement
            function checkAllPdfs() {
                const buttons = document.querySelectorAll('.pdf-button[data-eotp]');
                const eotps = Array.from(buttons)
                    .map(btn => btn.getAttribute('data-eotp'))
                    .filter(eotp => eotp && eotp.trim() !== '');

                if (eotps.length === 0) {
                    console.log('Aucun EOTP √† v√©rifier');
                    return;
                }

                console.log(`V√©rification de ${eotps.length} PDF...`);

                // Marquer tous les boutons comme en cours de v√©rification
                buttons.forEach(button => {
                    updateButtonState(button, 'checking', 'V√©rification...', true);
                });

                // Construire l'URL avec tous les EOTP
                const params = eotps.map(eotp => `eotp=${encodeURIComponent(eotp)}`).join('&');

                // Timeout pour √©viter les blocages
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 secondes max

                fetch(`/api/pdf-status?${params}`, {
                    signal: controller.signal,
                    method: 'GET'
                })
                    .then(response => {
                        clearTimeout(timeoutId);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('R√©sultats v√©rification PDF:', data);

                        buttons.forEach(button => {
                            const eotp = button.getAttribute('data-eotp');
                            if (!eotp) {
                                updateButtonState(button, 'not-available', 'EOTP manquant', true);
                                return;
                            }

                            const result = data[eotp];
                            if (!result) {
                                updateButtonState(button, 'not-available', 'Erreur v√©rification', true);
                                return;
                            }

                            pdfStates.set(eotp, {
                                checked: true,
                                exists: result.exists,
                                url: result.url
                            });

                            if (result.exists) {
                                updateButtonState(button, 'available', 'Voir le PDF', false);
                            } else {
                                updateButtonState(button, 'not-available', 'PDF non disponible', true);
                            }
                        });
                    })
                    .catch(error => {
                        clearTimeout(timeoutId);
                        console.error('Erreur v√©rification PDF en lot:', error);

                        // En cas d'erreur, permettre la v√©rification individuelle
                        buttons.forEach(button => {
                            updateButtonState(button, 'checking', 'Cliquer pour v√©rifier', false);
                        });
                    });
            }

            // Mise √† jour de l'√©tat d'un bouton
            function updateButtonState(button, state, text, disabled) {
                if (!button) return;

                const textSpan = button.querySelector('.pdf-text');
                const spinner = button.querySelector('.pdf-spinner');
                let icon = button.querySelector('.pdf-icon');

                // Supprimer toutes les classes d'√©tat
                button.classList.remove('checking', 'available', 'not-available');
                button.classList.add(state);
                button.disabled = disabled;

                if (textSpan) {
                    textSpan.textContent = text;
                }

                // G√©rer l'affichage du spinner vs ic√¥ne
                if (state === 'checking') {
                    if (spinner) spinner.style.display = 'block';
                    if (icon) icon.style.display = 'none';
                } else {
                    if (spinner) spinner.style.display = 'none';

                    // Ajouter l'ic√¥ne PDF si elle n'existe pas et que le PDF est disponible
                    if (!icon && state === 'available') {
                        icon = document.createElement('svg');
                        icon.className = 'pdf-icon';
                        icon.setAttribute('viewBox', '0 0 24 24');
                        icon.setAttribute('fill', 'currentColor');
                        icon.innerHTML = '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zM9.498 16.19c-.309.29-.765.42-1.296.42a2.23 2.23 0 0 1-.308-.018v1.426H7v-3.936A7.558 7.558 0 0 1 8.219 14c.557 0 .953.106 1.22.319.254.202.426.533.426.923-.001.392-.131.723-.367.948zm3.807 1.355c-.42.349-1.059.515-1.84.515-.468 0-.799-.03-1.024-.06v-3.917A7.947 7.947 0 0 1 11.66 14c.757 0 1.249.136 1.633.426.415.308.675.799.675 1.504 0 .763-.279 1.29-.663 1.615zM17 14.77h-1.532v.911H16.9v.734h-1.432v1.604h-.906V14.03H17v.74zM14 9h-1V4l5 5h-4z"/>';
                        button.insertBefore(icon, textSpan);
                    }

                    if (icon) {
                        icon.style.display = state === 'available' ? 'block' : 'none';
                    }
                }
            }

            // Calculer les statistiques modifi√©es
            document.addEventListener('DOMContentLoaded', function() {
                let currentYearAmount = 0;
                let currentContractsCount = 0;
                const currentYear = new Date().getFullYear();

                // Parcourir tous les contrats pour calculer les statistiques
                const contractItems = document.querySelectorAll('.contract-item');
                contractItems.forEach(item => {
                    // Calculer le montant pour l'ann√©e en cours seulement
                    const amountElements = item.querySelectorAll('.contract-meta span');
                    let contractAmount = 0;
                    let contractStartYear = null;
                    let contractEndYear = null;

                    // R√©cup√©rer le montant
                    amountElements.forEach(span => {
                        if (span.textContent.includes('üí∞')) {
                            const amountText = span.textContent.replace(/[‚Ç¨,\süí∞Montant:]/g, '');
                            const amount = parseFloat(amountText);
                            if (!isNaN(amount)) {
                                contractAmount = amount;
                            }
                        }
                    });

                    // R√©cup√©rer les dates du contrat depuis la section dates
                    const contractDates = item.querySelector('.contract-dates');
                    if (contractDates) {
                        const datesText = contractDates.textContent;
                        // Extraire les ann√©es des dates (format DD/MM/YYYY)
                        const dateRegex = /(\d{2}\/\d{2}\/(\d{4}))/g;
                        const matches = [...datesText.matchAll(dateRegex)];

                        if (matches.length >= 2) {
                            contractStartYear = parseInt(matches[0][2]);
                            contractEndYear = parseInt(matches[1][2]);
                        } else if (matches.length === 1) {
                            contractStartYear = parseInt(matches[0][2]);
                            contractEndYear = currentYear; // Si pas de date de fin, consid√©rer jusqu'√† maintenant
                        }
                    }

                    // V√©rifier si le contrat est actif pendant l'ann√©e en cours (en cours)
                    if (contractStartYear &&
                        contractStartYear <= currentYear &&
                        (!contractEndYear || contractEndYear >= currentYear)) {

                        // Incr√©menter le nombre de contrats en cours
                        currentContractsCount++;

                        // Ajouter au montant si le montant est valide
                        if (contractAmount > 0) {
                            currentYearAmount += contractAmount;
                        }
                    }
                });

                // Mettre √† jour les statistiques
                const currentYearAmountElement = document.getElementById('currentYearAmount');
                const currentContractsElement = document.getElementById('currentContracts');

                if (currentContractsElement) {
                    currentContractsElement.textContent = currentContractsCount;
                }

                if (currentYearAmountElement) {
                    currentYearAmountElement.textContent = currentYearAmount.toLocaleString('fr-FR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    }) + ' ‚Ç¨';
                }

                // Gestion des filtres
                const yearInput = document.getElementById('year');
                if (yearInput) {
                    yearInput.addEventListener('input', function() {
                        this.value = this.value.replace(/[^0-9]/g, '');
                    });
                }

                // V√©rifier les PDF au chargement (avec un petit d√©lai pour laisser la page se charger)
                setTimeout(() => {
                    checkAllPdfs();
                }, 1000);
            });
        </script>
    </body>
</html>